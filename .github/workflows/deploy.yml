name: Test and Deploy to EC2

on:
  push:
    branches:
      - main

jobs:
  test:
      name: Run Tests
      runs-on: ubuntu-latest
  
      services:
        postgres:
          image: postgres:latest
          ports:
            - 5432:5432
          env:
            POSTGRES_DB: roomify
            POSTGRES_USER: postgres
            POSTGRES_PASSWORD: password
          options: >-
            --health-cmd "pg_isready"
            --health-interval 10s
            --health-timeout 5s
            --health-retries 5
  
      steps:
        - name: Checkout code
          uses: actions/checkout@v4
  
        - name: Set up Java
          uses: actions/setup-java@v4
          with:
            java-version: '21'
            distribution: 'temurin'
  
        - name: Override Spring Boot DB config for GitHub Actions
          run: |
            echo "spring.datasource.url=jdbc:postgresql://localhost:5432/roomify" > src/test/resources/application.properties
            echo "spring.datasource.username=postgres" >> src/test/resources/application.properties
            echo "spring.datasource.password=password" >> src/test/resources/application.properties
            echo "spring.jpa.hibernate.ddl-auto=create-drop" >> src/test/resources/application.properties
  
        - name: Run tests
          run: mvn clean test
        
  deploy:
    name: Deploy to EC2
    needs: test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy via SSH
        run: |
          ssh -i ~/.ssh/id_rsa ubuntu@${{ secrets.EC2_HOST }} << 'EOF'
            cd ~/Roomify
            git pull origin main
            docker-compose down
            docker-compose up --build -d
          EOF
